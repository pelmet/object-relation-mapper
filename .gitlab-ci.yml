stages:
  - code-check
  - test

lint:
  tags:
    - php71
    - shell
  stage: code-check
  script:
    - find ./ -type f -name '*.php' | xargs -I {} php -l {}

phpstan:
  tags:
    - php71
    - shell
  stage: code-check
  script:
    - phpstan analyze -l 4 --autoload-file=_tests/_ps-autoload.php Base QueryBuilder ColumnType ConfigStorage Connector DataExchange DataMiner Exception Search

test:
  tags:
    - php71
    - shell
  stage: test
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN docker.xcroco.com
    - docker-compose up -d
    - sleep 3
    - docker exec -t php-55 phpunit
    - docker exec -t php-71 phpunit
    - docker-compose stop
    - docker-compose rm -f
    - docker volume rm `docker volume ls -q -f dangling=true` > /dev/null